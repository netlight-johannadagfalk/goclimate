<%= form_with(model: [:admin, calculator], local: true, html: { 'data-controller': 'item-order', class: 'space-y-3' }) do |form| %>
  <% if calculator.errors.any? %>
    <div>
      <h2><%= pluralize(calculator.errors.count, "error") %> prohibited this calculator from being saved:</h2>

      <ul>
        <% calculator.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= form.hidden_field :category_order, 'data-target': 'item-order.order' %>

  <div class="flex flex-col">
    <%= form.label :name, class: 'font-bold' %>
    <%= form.text_field :name, class: 'input' %>
  </div>

  <div class="flex flex-row space-x-1">
    <%= form.check_box :survey %>
    <%= form.label :survey, class: 'font-bold' %>
  </div>

  <h2 class="heading">Form design</h2>
  <div data-controller="add-nested-fields" class="space-y-6">
    <% @calculator.categories.each_with_index do |category, category_index| %>
      <%= fields_for "business_calculator[categories_attributes][#{category_index}]", category do |category_fields| %>
        <%= category_fields.hidden_field :id %>

        <div data-target="item-order.item" data-id="<%= category.id %>" class="space-y-3 callout">
          <div class="flex flex-row space-x-1">
            <div class="flex flex-col w-1/12">
              <%= category_fields.label :position, class: 'font-bold' %>
              <div class="select-wrapper">
                <select class="select text-lg" data-target="item-order.select" data-action="item-order#move" data-position="<%= category_index %>">
                  <% (1..@calculator.categories.length).to_a.each do |number| %>
                    <option value="<%= number %>" <%= number - 1 == category_index ? 'selected' : '' %>><%= number %></option>
                  <% end %>
                </select>
              </div>
            </div>
            <div class="flex flex-col w-10/12">
              <%= category_fields.label :category_name, class: 'font-bold' %>
              <%= category_fields.text_field :name, class: 'input text-lg font-semibold' %>
            </div>
            <div class="flex flex-col w-1/12">
              <label class="font-bold">
                <%= category_fields.check_box :_destroy %>
                Delete
              </label>
            </div>
          </div>

          <div class="flex flex-col border-b border-b-gray-accent pb-3">
            <%= category_fields.label :description, class: 'font-bold' %>
            <%= category_fields.text_field :description, class: 'input' %>
          </div>

          <div data-controller="item-order" class="space-y-6">
            <%= category_fields.hidden_field :field_order, 'data-target': 'item-order.order' %>
            <% category.fields.each_with_index do |field, field_index| %>
              <%= fields_for "business_calculator[categories_attributes][#{category_index}][fields_attributes][#{field_index}]", field do |field_fields| %>
                <div class="flex flex-row" data-target="item-order.item" data-id="<%= field.id %>">
                  <%= field_fields.hidden_field :id %>
                  <div class="w-1/12">
                    <%= field_fields.label :position, class: 'font-bold' %>
                    <div class="select-wrapper">
                      <select class="select" data-target="item-order.select" data-action="item-order#move" data-position="<%= field_index %>">
                        <% (1..category.fields.length).to_a.each do |number| %>
                          <option value="<%= number %>" <%= number - 1 == field_index ? 'selected' : '' %>><%= number %></option>
                        <% end %>
                      </select>
                    </div>
                  </div>
                  <%= render "field_layout", fields: field_fields, field: field %>
                </div>
              <% end %>
            <% end %>
          </div>
          <%= render "add_field", fields_for: "business_calculator[categories_attributes][#{category_index}][fields_attributes][#{category.fields.length}]" %>
          <p class="text-muted">Please note that all open ended fields will automatically have a "free form" unit.</p>
        </div>
      <% end %>
    <% end %>

    <%= fields_for "business_calculator[categories_attributes][#{@calculator.categories.length}]", BusinessCalculators::CalculatorCategory.new do |category_fields| %>
      <div class="hidden callout" data-target="add-nested-fields.template">
        <%= category_fields.text_field :name, class: 'input font-bold w-full text-lg add-nested-fields-input-field', 'data-target': 'add-nested-fields.templateInput', placeholder: 'Category name ...'  %>
      </div>
    <% end %>

    <div class="space-y-3" data-target="add-nested-fields.destination"></div>

    <div>
      <button type="button" class="button" data-action="add-nested-fields#cloneToDestinationWithFirstNumberIncremented">
        <i class="fas fa-plus" aria-hidden="true"></i> Add category
      </button>
    </div>
  </div>

  <div class="text-right">
    <%= form.submit class: 'button button-cta' %>
  </div>
<% end %>
